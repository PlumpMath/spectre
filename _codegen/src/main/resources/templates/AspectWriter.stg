aspect_writer(msgTypes) ::= <<

package skadistats.spectre;

import java.io.IOException;
import java.io.OutputStream;
import java.io.DataOutputStream;
import java.util.List;
import java.util.LinkedList;
import org.apache.mahout.math.Varint;

import skadistats.spectre.err.*;
import skadistats.spectre.proto.Util;


public class AspectWriter {
    protected int tick;
    protected List strTable; 
    protected OutputStream outStream;

    public AspectWriter(OutputStream outStream, int replayId) throws IOException {
        this.outStream = outStream;
        this.strTable = new LinkedList<String>();

        // write replayId to stream
        Util.Info info = Util.Info.newBuilder()
                         .setReplayId(replayId)
                         .build();
        writeMsg(1, info.toByteArray());
    }

    protected void writeMsg(int msgType, byte[] msgData) throws IOException {
        DataOutputStream dout = new DataOutputStream(outStream);

        Varint.writeUnsignedVarInt(msgType, dout);        // msgType
        Varint.writeUnsignedVarInt(msgData.length, dout); // msgSize
        outStream.write(msgData); // msg
    }

    public int indexString(String str) {
        int strIdx = strTable.indexOf(str);
        if (strIdx == -1) {
            strIdx = strTable.size();
            strTable.add(str);
        }
        return strIdx;
    }

    public void setTick(int tick) throws IOException {
        if (tick < this.tick)
            throw new OutOfOrderWrite(tick+" < "+this.tick);
        else if (tick > this.tick) {
            Util.Segment segment = Util.Segment.newBuilder()
                .setTick(tick)
                .build();
            writeMsg(0, segment.toByteArray());
            this.tick = tick;
        } else {
            // do nothing
        }
    }

    public static AspectWriter newWriter(OutputStream outStream, String aspectPath, int replayId)
        throws AspectNotFound, IOException {

        $msgTypes:instantiate_msg_type()$

        throw new AspectNotFound();
    }

    $msgTypes:define_writers()$

    public void close() throws IOException {
        // write string table
        Util.StringTable stable = Util.StringTable.newBuilder()
            .addAllValue(strTable)
            .build();
        writeMsg(2, stable.toByteArray());
        outStream.close();
    }
}
>>

instantiate_msg_type(msgType) ::= <<
if (aspectPath.equals("$msgType.aspectPath$")) {
    return new $msgType.readWritePkg$.Writer(outStream, replayId);
}
>>

define_writers(msgType) ::= <<
public void write($msgType.protoPkg$.$msgType.protoFullCls$ msg) throws IOException {
    throw new MismatchedAspectClass("Incorrect Writer instantiated");
}
>>
